---
# HPA for Archivist Worker (Optimized for local/offline deployment)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: archivist-worker-hpa
  namespace: archivist
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: archivist-worker
  minReplicas: 1  # Start with 1 for local deployment
  maxReplicas: 4  # Max 4 workers for personal machine
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 75  # Allow higher utilization locally
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 85
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # 5 minutes
      policies:
      - type: Pods
        value: 1  # Scale down 1 pod at a time
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 30  # Quick scale up for batch jobs
      policies:
      - type: Pods
        value: 1  # Add 1 pod at a time
        periodSeconds: 30

---
# HPA for Qdrant (Conservative for local deployment)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: qdrant-hpa
  namespace: archivist
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: qdrant
  minReplicas: 1
  maxReplicas: 2  # Max 2 for local
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 85
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
    scaleUp:
      stabilizationWindowSeconds: 60

---
# HPA for Search Service (Conservative for local deployment)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: search-service-hpa
  namespace: archivist
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: search-service
  minReplicas: 1
  maxReplicas: 2  # Max 2 for local
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 85
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
    scaleUp:
      stabilizationWindowSeconds: 60

---
# HPA for Graph Service (Conservative for local deployment)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: graph-service-hpa
  namespace: archivist
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: graph-service
  minReplicas: 1
  maxReplicas: 2  # Max 2 for local
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 85
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
    scaleUp:
      stabilizationWindowSeconds: 60
